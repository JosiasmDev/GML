{% extends 'jobs/base.html' %}

{% block content %}
<div class="row">
    <!-- Panel de búsqueda -->
    <div class="col-md-4">
        <div class="search-container">
            <h5 class="mb-3">Búsqueda de Ofertas</h5>
            <div class="d-flex justify-content-end mb-3">
                <button id="deleteAllButton" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Borrar Todas las Ofertas
                </button>
            </div>
            <form id="searchForm">
                <div class="mb-3">
                    <label for="keywords" class="form-label">Palabras clave</label>
                    <input type="text" class="form-control" id="keywords" name="keywords" required>
                </div>
                <div class="mb-3">
                    <div class="form-select" id="provinciasDiv">
                        <label for="of_provincia" class="form-label">en...</label>
                        <select class="chosen-select" data-placeholder="Toda España" id="of_provincia" name="of_provincia" title="Selecciona una de las opciones o escribe tu opción">
                            <option value="0" selected="true">Toda España</option>
                            <option value="foreign">El extranjero</option>
                            <optgroup label="Más comunes">
                                <option value="33">Madrid</option>
                                <option value="9">Barcelona</option>
                                <option value="49">Valencia/València</option>
                                <option value="43">Sevilla</option>
                            </optgroup>
                            <optgroup label="Todas">
                                <option value="28">A Coruña</option>
                                <option value="2">Álava/Araba</option>
                                <option value="3">Albacete</option>
                                <option value="4">Alicante/Alacant</option>
                                <option value="5">Almería</option>
                                <option value="6">Asturias</option>
                                <option value="7">Ávila</option>
                                <option value="8">Badajoz</option>
                                <option value="9">Barcelona</option>
                                <option value="10">Burgos</option>
                                <option value="11">Cáceres</option>
                                <option value="12">Cádiz</option>
                                <option value="13">Cantabria</option>
                                <option value="14">Castellón/Castelló</option>
                                <option value="15">Ceuta</option>
                                <option value="16">Ciudad Real</option>
                                <option value="17">Córdoba</option>
                                <option value="18">Cuenca</option>
                                <option value="19">Girona</option>
                                <option value="21">Granada</option>
                                <option value="22">Guadalajara</option>
                                <option value="23">Guipúzcoa/Gipuzkoa</option>
                                <option value="24">Huelva</option>
                                <option value="25">Huesca</option>
                                <option value="26">Islas Baleares/Illes Balears</option>
                                <option value="27">Jaén</option>
                                <option value="29">La Rioja</option>
                                <option value="20">Las Palmas</option>
                                <option value="30">León</option>
                                <option value="31">Lleida</option>
                                <option value="32">Lugo</option>
                                <option value="33">Madrid</option>
                                <option value="34">Málaga</option>
                                <option value="35">Melilla</option>
                                <option value="36">Murcia</option>
                                <option value="37">Navarra</option>
                                <option value="38">Ourense</option>
                                <option value="39">Palencia</option>
                                <option value="40">Pontevedra</option>
                                <option value="41">Salamanca</option>
                                <option value="46">Santa Cruz de Tenerife</option>
                                <option value="42">Segovia</option>
                                <option value="43">Sevilla</option>
                                <option value="44">Soria</option>
                                <option value="45">Tarragona</option>
                                <option value="47">Teruel</option>
                                <option value="48">Toledo</option>
                                <option value="49">Valencia/València</option>
                                <option value="50">Valladolid</option>
                                <option value="51">Vizcaya/Bizkaia</option>
                                <option value="52">Zamora</option>
                                <option value="53">Zaragoza</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <button type="submit" id="searchOffers" class="btn btn-cta w-100" title="Buscar trabajo con mis preferencias">
                    <i class="fas fa-search"></i> Buscar
                </button>
            </form>
        </div>

        <!-- Historial de búsquedas -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Historial de Búsquedas</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for search in search_history %}
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ search.keywords }}</h6>
                            <small>{{ search.created_at|date:"d/m/Y H:i" }}</small>
                        </div>
                        <p class="mb-1">{{ search.location }} - {{ search.results_count }} resultados</p>
                    </div>
                    {% empty %}
                    <p class="text-muted">No hay búsquedas recientes</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de ofertas -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Ofertas de Trabajo</h5>
                <span class="badge bg-primary">{{ total_jobs }} ofertas</span>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    Mostrando {{ jobs.start_index }} a {{ jobs.end_index }} de {{ total_jobs }} ofertas
                </div>
                
                <!-- Filtros y Ordenación -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Filtros y Ordenación</h5>
                        <form method="get" action="{% url 'jobs:dashboard' %}" id="filterForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="filter_by">Filtrar por:</label>
                                        <select name="filter_by" id="filter_by" class="form-control">
                                            <option value="">Ninguno</option>
                                            <option value="salary" {% if filter_by == 'salary' %}selected{% endif %}>Salario</option>
                                            <option value="work_mode" {% if filter_by == 'work_mode' %}selected{% endif %}>Modo de trabajo</option>
                                            <option value="min_experience" {% if filter_by == 'min_experience' %}selected{% endif %}>Experiencia mínima</option>
                                            <option value="contract_type" {% if filter_by == 'contract_type' %}selected{% endif %}>Tipo de contrato</option>
                                            <option value="vacantes" {% if filter_by == 'vacantes' %}selected{% endif %}>Vacantes</option>
                                            <option value="inscritos" {% if filter_by == 'inscritos' %}selected{% endif %}>Inscritos</option>
                                            <option value="publication_date" {% if filter_by == 'publication_date' %}selected{% endif %}>Fecha</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="order_by">Ordenar por:</label>
                                        <select name="order_by" id="order_by" class="form-control">
                                            <option value="-created_at" {% if order_by == '-created_at' %}selected{% endif %}>Fecha de creación (más reciente)</option>
                                            <option value="created_at" {% if order_by == 'created_at' %}selected{% endif %}>Fecha de creación (más antigua)</option>
                                            <option value="title" {% if order_by == 'title' %}selected{% endif %}>Título</option>
                                            <option value="company" {% if order_by == 'company' %}selected{% endif %}>Empresa</option>
                                            <option value="salary" {% if order_by == 'salary' %}selected{% endif %}>Salario</option>
                                            <option value="work_mode" {% if order_by == 'work_mode' %}selected{% endif %}>Modo de trabajo</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary">Aplicar</button>
                                <a href="{% url 'jobs:dashboard' %}" class="btn btn-secondary">Resetear</a>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="jobsList">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Título</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <input type="text" class="form-control form-control-sm mb-2" id="filter_title" placeholder="Filtrar título...">
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('title')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('title')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Empresa</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <input type="text" class="form-control form-control-sm mb-2" id="filter_company" placeholder="Filtrar empresa...">
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('company')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('company')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Ubicación</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <input type="text" class="form-control form-control-sm mb-2" id="filter_location" placeholder="Filtrar ubicación...">
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('location')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('location')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Salario</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <input type="text" class="form-control form-control-sm mb-2" id="filter_salary" placeholder="Filtrar salario...">
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('salary')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('salary')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Modo de trabajo</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <select class="form-select form-select-sm mb-2" id="filter_work_mode">
                                                    <option value="">Todos</option>
                                                    {% for value in unique_values.work_mode %}
                                                        {% if value %}
                                                            <option value="{{ value }}">{{ value }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('work_mode')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('work_mode')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Experiencia</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <select class="form-select form-select-sm mb-2" id="filter_min_experience">
                                                    <option value="">Todos</option>
                                                    {% for value in unique_values.min_experience %}
                                                        {% if value %}
                                                            <option value="{{ value }}">{{ value }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('min_experience')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('min_experience')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Tipo de contrato</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <select class="form-select form-select-sm mb-2" id="filter_contract_type">
                                                    <option value="">Todos</option>
                                                    {% for value in unique_values.contract_type %}
                                                        {% if value %}
                                                            <option value="{{ value }}">{{ value }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('contract_type')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('contract_type')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Estudios</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <select class="form-select form-select-sm mb-2" id="filter_studies">
                                                    <option value="">Todos</option>
                                                    {% for value in unique_values.studies %}
                                                        {% if value %}
                                                            <option value="{{ value }}">{{ value }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('studies')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('studies')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Idiomas</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <select class="form-select form-select-sm mb-2" id="filter_languages">
                                                    <option value="">Todos</option>
                                                    {% for value in unique_values.languages %}
                                                        {% if value %}
                                                            <option value="{{ value }}">{{ value }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('languages')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('languages')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Conocimientos</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <input type="text" class="form-control form-control-sm mb-2" id="filter_required_skills" placeholder="Filtrar conocimientos...">
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('required_skills')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('required_skills')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Vacantes</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <input type="text" class="form-control form-control-sm mb-2" id="filter_vacantes" placeholder="Filtrar vacantes...">
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('vacantes')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('vacantes')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Inscritos</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <input type="text" class="form-control form-control-sm mb-2" id="filter_inscritos" placeholder="Filtrar inscritos...">
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('inscritos')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('inscritos')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="d-flex flex-column">
                                        <span>Fecha</span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-filter"></i>
                                            </button>
                                            <div class="dropdown-menu p-2">
                                                <input type="text" class="form-control form-control-sm mb-2" id="filter_publication_date" placeholder="Filtrar fecha...">
                                                <button class="btn btn-primary btn-sm w-100" onclick="applyFilter('publication_date')">Aplicar</button>
                                            </div>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <button class="btn btn-outline-secondary" onclick="sortTable('publication_date')">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </div>
                                    </div>
                                </th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for job in jobs %}
                            <tr>
                                <td><a href="{{ job.url }}" target="_blank">{{ job.title }}</a></td>
                                <td>{{ job.company }}</td>
                                <td>{{ job.location }}</td>
                                <td>{{ job.salary|default:"No especificado" }}</td>
                                <td>{{ job.work_mode|default:"No especificado" }}</td>
                                <td>{{ job.min_experience|default:"No especificado" }}</td>
                                <td>{{ job.contract_type|default:"No especificado" }}</td>
                                <td>{{ job.studies|default:"No especificado" }}</td>
                                <td>{{ job.languages|default:"No especificado" }}</td>
                                <td>{{ job.required_skills|default:"No especificado"|truncatechars:30 }}</td>
                                <td>{{ job.vacantes|default:"No especificado" }}</td>
                                <td>{{ job.inscritos|default:"No especificado" }}</td>
                                <td>{{ job.publication_date|default:"No especificado" }}</td>
                                <td>
                                    <a href="{% url 'jobs:job_detail' job.id %}" class="btn btn-sm btn-info me-1" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ job.url }}" target="_blank" class="btn btn-sm btn-primary" title="Ver en InfoJobs">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="14" class="text-center">No hay ofertas de trabajo disponibles</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginación -->
                {% if jobs.has_other_pages %}
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if jobs.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ jobs.previous_page_number }}{% if filter_by %}&filter_by={{ filter_by }}{% endif %}{% if order_by %}&order_by={{ order_by }}{% endif %}" data-page="{{ jobs.previous_page_number }}">Anterior</a>
                        </li>
                        {% endif %}

                        {% for num in jobs.paginator.page_range %}
                            {% if num == jobs.number %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > jobs.number|add:'-3' and num < jobs.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if filter_by %}&filter_by={{ filter_by }}{% endif %}{% if order_by %}&order_by={{ order_by }}{% endif %}" data-page="{{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if jobs.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ jobs.next_page_number }}{% if filter_by %}&filter_by={{ filter_by }}{% endif %}{% if order_by %}&order_by={{ order_by }}{% endif %}" data-page="{{ jobs.next_page_number }}">Siguiente</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Inicializar el selector de provincias con Chosen
    $("#of_provincia").chosen({
        width: "100%",
        no_results_text: "No se encontraron resultados para",
        placeholder_text_single: "Selecciona una ubicación",
        search_contains: true
    });
    
    // Manejar el envío del formulario de búsqueda
    $('#searchForm').on('submit', function(e) {
        e.preventDefault();
        prepareSearch();
    });
    
    // Función prepareSearch
    function prepareSearch() {
        const keywords = $('#keywords').val();
        const locationValue = $('#of_provincia').val();
        
        // Validar que se hayan ingresado palabras clave
        if (!keywords || keywords.trim() === '') {
            showError('Por favor, introduce algunas palabras clave para buscar');
            return;
        }
        
        // Mostrar indicador de carga
        $('#searchOffers').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Buscando...');
        
        $.ajax({
            url: "{% url 'jobs:search_jobs' %}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                keywords: keywords,
                location: locationValue
            }),
            success: function(response) {
                console.log('Respuesta del servidor:', response);
                if (response.success) {
                    // Recargar la página para mostrar los resultados
                    window.location.reload();
                } else {
                    showError(response.message || 'Error en la búsqueda');
                    // Restaurar el botón
                    $('#searchOffers').prop('disabled', false).html('<i class="fas fa-search"></i> Buscar');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error en la petición:', xhr.responseText, status, error);
                showError('Error al realizar la búsqueda: ' + error);
                // Restaurar el botón
                $('#searchOffers').prop('disabled', false).html('<i class="fas fa-search"></i> Buscar');
            }
        });
    }
    
    // Función para mostrar mensajes de error
    function showError(message) {
        // Crear el elemento de alerta si no existe
        let alertDiv = $('#searchAlert');
        if (alertDiv.length === 0) {
            alertDiv = $('<div id="searchAlert" class="alert alert-danger alert-dismissible fade show" role="alert">' +
                '<span class="message"></span>' +
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>');
            $('.search-container').prepend(alertDiv);
        }
        
        // Actualizar el mensaje y mostrar la alerta
        alertDiv.find('.message').text(message);
        alertDiv.show();
        
        // Ocultar la alerta después de 5 segundos
        setTimeout(function() {
            alertDiv.fadeOut();
        }, 5000);
    }

    // Manejar el toggle de favoritos
    $('.toggle-favorite').on('click', function() {
        const jobCard = $(this).closest('.job-card');
        const jobId = jobCard.data('job-id');
        
        $.ajax({
            url: `/job/${jobId}/toggle-favorite/`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    const icon = jobCard.find('.toggle-favorite i');
                    icon.toggleClass('fa-star fa-star-o');
                }
            }
        });
    });
    
    // Manejar la eliminación de ofertas
    $('.delete-job').on('click', function() {
        if (!confirm('¿Estás seguro de que quieres eliminar esta oferta?')) {
            return;
        }
        
        const jobCard = $(this).closest('.job-card');
        const jobId = jobCard.data('job-id');
        
        $.ajax({
            url: `/job/${jobId}/delete/`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    jobCard.fadeOut(function() {
                        $(this).remove();
                    });
                }
            }
        });
    });

    // Función para borrar todas las ofertas
    $('#deleteAllButton').click(function() {
        if (confirm('¿Estás seguro de que quieres borrar todas las ofertas? Esta acción no se puede deshacer.')) {
            $.ajax({
                url: '/delete-all/',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function() {
                    alert('Error al comunicarse con el servidor');
                }
            });
        }
    });

    // Manejar cambios en los filtros
    $('#filter_by, #order_by').on('change', function() {
        $('#filterForm').submit();
    });

    // Inicializar los filtros con los valores actuales
    if ('{{ filter_by }}' && '{{ filter_value }}') {
        $(`#filter_${'{{ filter_by }}'}`).val('{{ filter_value }}');
    }
});

// Función para aplicar filtros
function applyFilter(field) {
    const value = $(`#filter_${field}`).val();
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('filter_by', field);
    currentUrl.searchParams.set('filter_value', value);
    currentUrl.searchParams.set('page', '1'); // Resetear a la primera página
    window.location.href = currentUrl.toString();
}

// Función para ordenar la tabla
function sortTable(field) {
    const currentUrl = new URL(window.location.href);
    const currentOrder = currentUrl.searchParams.get('order_by');
    
    // Determinar el nuevo orden
    let newOrder;
    if (currentOrder === field) {
        newOrder = `-${field}`; // Cambiar a orden descendente
    } else if (currentOrder === `-${field}`) {
        newOrder = field; // Cambiar a orden ascendente
    } else {
        newOrder = field; // Ordenar por primera vez
    }
    
    currentUrl.searchParams.set('order_by', newOrder);
    currentUrl.searchParams.set('page', '1'); // Resetear a la primera página
    window.location.href = currentUrl.toString();
}

// Función para limpiar todos los filtros
function clearFilters() {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.delete('filter_by');
    currentUrl.searchParams.delete('filter_value');
    currentUrl.searchParams.set('page', '1');
    window.location.href = currentUrl.toString();
}
</script>
{% endblock %} 